# Feature Engineering Guide

## Complete Feature Reference

This document details all 200+ features generated by the pipeline, organized by category.

---

## Table of Contents

- [Technical Indicators](#technical-indicators)
- [Statistical Features](#statistical-features)
- [Volatility Features](#volatility-features)
- [Microstructure Features](#microstructure-features)
- [Risk Metrics](#risk-metrics)
- [Performance Metrics](#performance-metrics)
- [Multi-Timeframe Features](#multi-timeframe-features)
- [Advanced Statistical](#advanced-statistical)
- [Feature Usage Examples](#feature-usage-examples)

---

## Technical Indicators

### Moving Averages

**Simple Moving Average (SMA)**
```python
sma_5, sma_10, sma_20, sma_50, sma_100, sma_200
```
- Standard average price over N periods
- Used for trend identification
- Slower response than EMA

**Exponential Moving Average (EMA)**
```python
ema_5, ema_10, ema_20, ema_50, ema_100, ema_200
```
- Weighted average emphasizing recent prices
- Faster response to price changes
- Better for recent trends

### Trend Indicators

**MACD (Moving Average Convergence Divergence)**
```python
macd, macd_signal, macd_histogram
```
- Momentum indicator
- MACD = EMA(12) - EMA(26)
- Signal = EMA(9) of MACD
- Histogram = MACD - Signal
- Usage: Trend changes, momentum

**ADX (Average Directional Index)**
```python
adx_14, plus_di_14, minus_di_14
```
- Measures trend strength (0-100)
- +DI: Uptrend strength
- -DI: Downtrend strength
- Signals: Strong trend > 25

**Aroon Indicator**
```python
aroon_up, aroon_down, aroon_osc
```
- Measures highest/lowest point positions
- Range: 0-100
- Oscillator = Aroon Up - Aroon Down
- Signals: Trend reversals

### Momentum Indicators

**RSI (Relative Strength Index)**
```python
rsi_14
```
- Momentum oscillator (0-100)
- Overbought > 70, Oversold < 30
- Divergences signal reversals
- Formula: 100 - (100 / (1 + RS))

**Stochastic Oscillator**
```python
stoch_k, stoch_d
```
- Compares price to range
- K = 14-period Stochastic
- D = 3-period SMA of K
- Overbought > 80, Oversold < 20

**CCI (Commodity Channel Index)**
```python
cci_20
```
- Measures deviation from average price
- Range: typically -100 to +100
- Signals: > 100 (overbought), < -100 (oversold)

### Volatility Indicators

**Bollinger Bands**
```python
bb_upper_20, bb_middle_20, bb_lower_20
bb_upper_50, bb_middle_50, bb_lower_50
bb_bandwidth, bb_pct_b
```
- Upper = SMA + 2*StdDev
- Lower = SMA - 2*StdDev
- Bandwidth = (Upper - Lower) / Middle
- %B = (Close - Lower) / (Upper - Lower)

**ATR (Average True Range)**
```python
atr_14, natr_14
```
- Average price movement range
- True Range = max(H-L, |H-C|, |L-C|)
- ATR = 14-period SMA of True Range
- NATR = (ATR / Close) * 100

**Keltner Channels**
```python
kc_upper, kc_middle, kc_lower, kc_width
```
- Similar to Bollinger Bands
- Uses ATR instead of standard deviation
- More stable in volatile markets

### Volume Indicators

**OBV (On-Balance Volume)**
```python
obv, obv_ema
```
- Cumulative volume indicator
- Increases on up days, decreases on down days
- Divergences signal reversals

**MFI (Money Flow Index)**
```python
mfi_14
```
- Volume-weighted RSI
- Range: 0-100
- Overbought > 80, Oversold < 20
- Combines price and volume

**Volume Rate of Change**
```python
vroc_10, vroc_20
```
- Percentage change in volume
- Signals volume trend changes

---

## Statistical Features

### Return Metrics

**Returns Calculation**
```python
simple_return        # (Close - Prev Close) / Prev Close
log_return          # ln(Close / Prev Close)
cumulative_return   # Cumulative sum of returns
```

**Return Statistics**
```python
mean_return         # Average return
median_return       # Median return
std_return          # Return standard deviation
max_return          # Maximum single return
min_return          # Minimum single return
return_range        # Max - Min
```

### Distribution Analysis

**Skewness & Kurtosis**
```python
skewness            # Asymmetry of distribution (-3 to 3)
kurtosis            # Tail heaviness (< 3 = light, > 3 = heavy)
excess_kurtosis     # Kurtosis - 3
```

**Jarque-Bera Test**
```python
jarque_bera_stat    # Test statistic
jarque_bera_pvalue  # P-value (< 0.05 = not normal)
```

**Q-Q Plot**
```python
qq_correlation      # Correlation with normal distribution
```

### Autocorrelation

**ACF (Autocorrelation Function)**
```python
acf_lag_1, acf_lag_5, acf_lag_10, acf_lag_20
```
- Correlation with own lagged values
- Detects mean reversion
- Range: -1 to 1

**PACF (Partial Autocorrelation Function)**
```python
pacf_lag_1, pacf_lag_5, pacf_lag_10, pacf_lag_20
```
- Direct correlation removing intermediate lags
- Useful for ARIMA modeling

### Stationarity Tests

**ADF (Augmented Dickey-Fuller)**
```python
adf_statistic       # Test statistic
adf_pvalue          # P-value (< 0.05 = stationary)
adf_critical_1pct   # Critical value at 1%
adf_critical_5pct   # Critical value at 5%
```

---

## Volatility Features

### Volatility Measures

**Historical Volatility**
```python
historical_vol_10   # 10-period standard deviation
historical_vol_20   # 20-period standard deviation
historical_vol_50   # 50-period standard deviation
```

**Realized Volatility**
```python
realized_vol_10     # sqrt(sum(log_return^2))
realized_vol_20
realized_vol_50
```

**Parkinson Volatility**
```python
parkinson_vol       # sqrt(ln(H/L)^2 / (4*ln(2)))
```
- Uses high-low range
- More efficient than close-to-close

**Garman-Klass Volatility**
```python
garman_klass_vol    # Combines OHLC data
```
- More efficient estimator
- Lower variance than historical vol

**Rogers-Satchell Volatility**
```python
rs_volatility       # sqrt(E[ln(H/C)*ln(H/O) + ln(L/C)*ln(L/O)])
```

### Volatility Dynamics

**Volatility Clustering**
```python
vol_clustering_ratio # Current vol / 20-period avg vol
vol_regime          # High (> 1.2), Normal (0.8-1.2), Low (< 0.8)
```

**Volatility of Volatility**
```python
vol_of_vol_10       # Volatility of 10-period volatility
vol_of_vol_20
```

---

## Microstructure Features

### Price Spread Analysis

**Bid-Ask Spread**
```python
price_spread        # High - Low as proxy for spread
spread_pct          # (High - Low) / Close
high_low_ratio      # High / Low
```

**VWAP (Volume-Weighted Average Price)**
```python
vwap                # Sum(Price * Volume) / Sum(Volume)
vwap_deviation      # (Close - VWAP) / Close
```

### Volume Analysis

**Volume Metrics**
```python
volume              # Raw trading volume
volume_ema          # 10-period EMA of volume
volume_sma          # 20-period SMA of volume
volume_ratio        # Current volume / Average volume
volume_trend        # Volume increasing/decreasing
```

**Volume-Price Confirmation**
```python
volume_price_trend  # Volume increases with directional moves
price_volume_trend  # Cumulative volume-price indicator
accumulation_dist   # Accumulation/Distribution line
```

### Order Flow

**Buy/Sell Pressure**
```python
buy_pressure        # (Close - Low) / (High - Low) * Volume
sell_pressure       # (High - Close) / (High - Low) * Volume
```

**Volume at Price**
```python
volume_above        # Volume trading above current price
volume_below        # Volume trading below current price
volume_profile      # Distribution of volume across price levels
```

---

## Risk Metrics

### Drawdown Analysis

**Maximum Drawdown**
```python
max_drawdown        # Largest drop from peak to trough
drawdown_duration   # Number of periods to recover
underwater_equity   # How far below peak
```

**Running Drawdown**
```python
running_drawdown_10  # Current drawdown from 10-period high
running_drawdown_20
running_drawdown_50
```

### Value at Risk

**VaR (Value at Risk)**
```python
var_95              # 95% confidence level
var_99              # 99% confidence level
var_99.9            # 99.9% confidence level
```
- Probability of loss exceeding VaR
- Example: VaR 95% = -2% means 95% chance loss ≤ 2%

**CVaR (Conditional Value at Risk)**
```python
cvar_95             # Average loss if VaR exceeded
cvar_99
cvar_99.9
```

### Beta & Alpha

**Market Beta**
```python
beta_10             # Market sensitivity
beta_20
beta_50
```
- Beta > 1: More volatile than market
- Beta < 1: Less volatile than market
- Beta = 1: Moves with market

**Alpha**
```python
alpha_10            # Return beyond market expectation
alpha_20
alpha_50
```

### Risk-Adjusted Returns

**Sharpe Ratio**
```python
sharpe_ratio_10     # (Return - Rf) / Volatility
sharpe_ratio_20
sharpe_ratio_50
```

**Sortino Ratio**
```python
sortino_ratio_10    # Penalizes downside volatility
sortino_ratio_20
sortino_ratio_50
```

**Calmar Ratio**
```python
calmar_ratio        # Annual Return / Max Drawdown
```

---

## Performance Metrics

### Return Analysis

**Total Return**
```python
total_return_10     # Return over N periods
total_return_20
total_return_50
```

**Annualized Return**
```python
annualized_return_10
annualized_return_20
annualized_return_50
```

**Excess Return**
```python
excess_return_10    # Return vs benchmark
excess_return_20
excess_return_50
```

### Win Rate Metrics

**Up/Down Days**
```python
up_days_ratio       # % of days with positive returns
down_days_ratio     # % of days with negative returns
average_up_day      # Average return on up days
average_down_day    # Average return on down days
up_down_ratio       # Up days / Down days
```

### Consistency

**Return Consistency**
```python
return_consistency  # Ratio of best to worst period return
consecutive_wins    # Longest winning streak
consecutive_losses  # Longest losing streak
```

---

## Multi-Timeframe Features

### Aggregated Features

Features calculated at multiple timeframes: 5m, 15m, 1h, 1d

**For each timeframe:**
```python
{timeframe}_sma_20      # SMA at timeframe
{timeframe}_rsi_14      # RSI at timeframe
{timeframe}_volatility  # Volatility at timeframe
{timeframe}_volume      # Volume at timeframe
```

### Cross-Timeframe Analysis

**Momentum Alignment**
```python
momentum_alignment      # RSI signals aligned across timeframes
volatility_term_structure  # Volatility across timeframes
volume_term_structure   # Volume across timeframes
```

**Trend Consistency**
```python
trend_alignment_score   # Score 0-1 indicating consistency
trend_conflict_signal   # When timeframes disagree
```

---

## Advanced Statistical

### Hurst Exponent

```python
hurst_exponent      # Mean-reverting (< 0.5), Random (= 0.5), Trending (> 0.5)
```

### Entropy Measures

```python
approximate_entropy  # Complexity of price series
sample_entropy       # Refined entropy measure
permutation_entropy  # Entropy of price orderings
```

### Information Coefficient

```python
ic_lagged_1         # Correlation with next-period returns
ic_lagged_5
ic_lagged_10
```

---

## Feature Usage Examples

### Example 1: Trend Detection

```python
from feature_engineering import FeatureEngineer
import pandas as pd

engineer = FeatureEngineer()
df = pd.read_csv('data.csv')  # with OHLCV columns

# Get features
features = engineer.process_full_pipeline(df)

# Extract trend features
sma_20 = features['technical_features']['sma_20']
rsi = features['technical_features']['rsi_14']
adx = features['technical_features']['adx_14']

# Simple trend identification
trending = (adx > 25)  # Strong trend
overbought = (rsi > 70)  # Potential reversal
oversold = (rsi < 30)   # Potential bounce

print(f"Trending: {trending}")
print(f"Overbought: {overbought}")
print(f"Oversold: {oversold}")
```

### Example 2: Risk Assessment

```python
# Extract risk features
max_drawdown = features['risk_metrics']['max_drawdown']
var_95 = features['risk_metrics']['var_95']
sharpe_ratio = features['performance_metrics']['sharpe_ratio_20']

# Risk assessment
high_risk = (max_drawdown < -0.15) or (var_95 < -0.10)
poor_risk_adjusted = (sharpe_ratio < 0.5)

print(f"High Risk: {high_risk}")
print(f"Poor Risk-Adjusted Returns: {poor_risk_adjusted}")
```

### Example 3: Mean Reversion

```python
# Extract statistical features
hurst = features['advanced_statistical']['hurst_exponent']
adf_pvalue = features['advanced_statistical']['adf_pvalue']

# Mean reversion signals
mean_reverting = (hurst < 0.5) and (adf_pvalue < 0.05)

if mean_reverting:
    print("Symbol shows mean-reversion characteristics")
    print("Consider range-trading strategies")
```

### Example 4: Volatility Regime

```python
# Extract volatility features
historical_vol = features['volatility_features']['historical_vol_20']
avg_vol = features['volatility_features']['historical_vol_50']
vol_regime = historical_vol / avg_vol

if vol_regime > 1.2:
    print("High volatility regime")
elif vol_regime < 0.8:
    print("Low volatility regime")
else:
    print("Normal volatility regime")
```

---

## Feature Correlation and Selection

### High Correlation Pairs (May indicate redundancy)

Common high correlations to watch:
- SMA 20 ↔ SMA 50: ~0.99
- EMA 20 ↔ EMA 50: ~0.98
- RSI ↔ Stochastic: ~0.85
- Historical Vol ↔ ATR: ~0.88

### Feature Selection Recommendations

**For Machine Learning:**
- Use PCA or feature importance ranking
- Remove correlated features (> 0.9)
- Scale features before modeling

**For Trading Signals:**
- Combine indicators from different categories
- Cross-confirm with multiple timeframes
- Use volatility-adjusted thresholds

---

## Computing Performance

### Feature Generation Times (approximate)

| Feature Category | Time for 250K records |
|-----------------|----------------------|
| Technical Indicators | 2-3 seconds |
| Statistical Features | 3-5 seconds |
| Volatility Features | 2-3 seconds |
| Microstructure | 1-2 seconds |
| Risk Metrics | 2-4 seconds |
| All Features | 12-20 seconds |

### Memory Usage

```python
# Approximate memory for 250K records:
- Raw OHLCV: 10 MB
- All Technical Features: 50 MB
- All Statistical: 30 MB
- Total with all features: ~250 MB
```

---

**Last Updated**: November 28, 2025  
**Version**: 1.1.0

